<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quiet Hours Test</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="images/favicon.svg" type="image/svg+xml">
</head>

<script async type='text/javascript' src='https://static.klaviyo.com/onsite/js/VNvqRc/klaviyo.js?company_id=VNvqRc'></script>
          <script type="text/javascript"> 
          //Initialize Klaviyo object on page load
          !function(){if(!window.klaviyo){window._klOnsite=window._klOnsite||[];try{window.klaviyo=new Proxy({},{get:function(n,i){return"push"===i?function(){var n;(n=window._klOnsite).push.apply(n,arguments)}:function(){for(var n=arguments.length,o=new Array(n),w=0;w<n;w++)o[w]=arguments[w];var t="function"==typeof o[o.length-1]?o.pop():void 0,e=new Promise((function(n){window._klOnsite.push([i].concat(o,[function(i){t&&t(i),n(i)}]))}));return e}}})}catch(n){window.klaviyo=window.klaviyo||[],window.klaviyo.push=function(){var n;(n=window._klOnsite).push.apply(n,arguments)}}}}(); </script>

<body>
    <div class="page">
        <img src="./images/gale.png" alt="Gale" class="logo-left gale-offset" />
        <div class="content">
            <nav>
                <a href="index.html">&larr; Back to Home</a>
            </nav>
            <h1>Quiet Hours Test</h1>

            <ol>
        <li>Subscribe your number to SMS messaging using the onsite form <button onclick="openForm()">Open Form</button>. You can find the teaser in the bottom left. You should be able to fill out the form as many times as you want, but if you don't see it show up, try resetting the form (clearing the cookies and refreshing the page). <button onclick="clearCookies()">Reset Form</button></li>
        <li>
            <label for="testInput">Enter phone number:</label>
            <input type="text" id="testInput" placeholder="+15085551234" />
            <button onclick="beginTest()">Begin Test</button>
        </li>
        <li>You should receive a text message in a few minutes.</li>
        <li>Continue following the instructions on your phone.</li>
    </ol>

    <p>Notes: You can repeat the test with the same number (ignoring step 1 on subsequent runs), but you need to wait until the first test has fully completed before beginning a subsequent test. You will have ~30 minutes after beginning a test to specify a time. You should begin this process at least 30 minutes before the time you wish to receive the test message.</p>

    <script>
        function clearCookies() {
            // Get all cookies
            const cookies = document.cookie.split(";");
            
            // Clear each cookie
            for (let cookie of cookies) {
                const eqPos = cookie.indexOf("=");
                const name = eqPos > -1 ? cookie.substr(0, eqPos).trim() : cookie.trim();
                
                // Delete the cookie by setting it to expire in the past
                document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
                document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=${window.location.hostname}`;
                document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.${window.location.hostname}`;
            }
            
            // Also clear localStorage and sessionStorage if needed
            localStorage.clear();
            sessionStorage.clear();
            
            console.log('All cookies and storage cleared');
            window.location.reload();
        }

        function openForm() {
            window._klOnsite = window._klOnsite || []; 
            window._klOnsite.push(['openForm', 'T4Ttmr']);
        }

        // Begin the test: validate phone input then send event POST
        function beginTest() {

            const inputElement = document.getElementById('testInput');
            const value = inputElement ? inputElement.value.trim() : '';

            // Validate: must start with '+' followed by exactly 11 digits
            const phoneRegex = /^\+\d{11}$/;
            if (!phoneRegex.test(value)) {
                alert('Please enter a phone number in the format +12345678901 (plus sign followed by 11 digits).');
                return; // don't send the POST request
            }

            const params = new URLSearchParams();
            params.append('company_id', 'VNvqRc');

            const requestBody = {
                data: {
                    type: "event",
                    attributes: {
                        properties: {
                            Brand: "Kids Book",
                            ProductID: 1111,
                            ProductName: "The Communist Manifesto"
                        },
                        metric: {
                            data: {
                                type: "metric",
                                attributes: {
                                    name: "Viewed Product",
                                    service: "string"
                                }
                            }
                        },
                        profile: {
                            data: {
                                type: "profile",
                                attributes: {
                                    phone_number: value
                                }
                            }
                        }
                    }
                }
            };

            const options = {
                method: 'POST',
                headers: {
                    accept: 'application/vnd.api+json',
                    revision: '2025-10-15',
                    'content-type': 'application/vnd.api+json',
                },
                body: JSON.stringify(requestBody)
            };

            fetch(`https://a.klaviyo.com/client/events?${params.toString()}`, options)
                .then(res => {
                    console.log("Success: ", res)
                    alert("Event sent successfully! Please check your phone for the next steps.")
                })
                .catch(err => {
                    console.error("Error: ", err)
                    alert("There was an error sending the event. Please check the logs or try again later.")
                });

        }
    </script>
        </div>
    </div>
</body>
